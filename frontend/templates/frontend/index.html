<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Genffice</title>
    <style>
      @media print {
        body { background: #fff; }
        .topbar, .ribbon, .sidebar, .footer { display: none !important; }
        .wrap { display: block; padding: 0; }
        .page { width: 210mm; margin: 0 auto; border: 0; box-shadow: none; }
        .editor { min-height: auto; padding: 20mm; }
      }
      :root {
        --blue: #0a73ff;
        --blue-dark: #0659c7;
        --bg: #f6f7fb;
        --panel: #ffffff;
        --border: #e6e8ef;
        --text: #111826;
        --muted: #657089;
        --icon: #3b465c;
        --shadow: 0 6px 24px rgba(16, 24, 40, 0.08);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      /* Top brand bar */
      .topbar {
        height: 54px; background: var(--blue); color:#fff;
        display:flex; align-items:center; gap:12px; padding:0 16px; box-shadow:var(--shadow);
      }
      .brand { font-weight:700; letter-spacing:.2px; }
      .docname {
        margin-left:auto; background:rgba(255,255,255,.15);
        border:1px solid rgba(255,255,255,.25); color:#fff; border-radius:8px;
        padding:6px 10px; min-width:180px;
      }
      .user { display:flex; align-items:center; gap:8px; }
      .user .dot { width:10px; height:10px; border-radius:50%; background:#7df18a; }

      /* Ribbon */
      .ribbon {
        background:#fff; border-bottom:1px solid var(--border);
        display:flex; align-items:center; gap:10px; padding:8px 12px;
        position:sticky; top:0; z-index:20;
      }
      .group { display:flex; align-items:center; gap:6px; padding:6px 10px; border-right:1px solid var(--border); }
      .btn{
        display:inline-flex; align-items:center; justify-content:center; gap:6px;
        height:34px; padding:0 10px; border:1px solid var(--border); border-radius:8px;
        background:#fff; color:var(--icon); cursor:pointer; user-select:none; transition:.12s;
        box-shadow:0 1px 0 rgba(0,0,0,.02);
      }
      .btn:hover{ background:#f4f6fb; }
      .btn:active{ transform:translateY(1px); }
      .btn.tog.active{ background:#ecf3ff; border-color:#cfe2ff; color:#0a53c1; }
      .select{ height:34px; border:1px solid var(--border); border-radius:8px; padding:0 10px; background:#fff; }
      .spacer{ flex:1; }

      /* Layout */
      .wrap{
        display:grid; grid-template-columns:auto 360px; gap:16px; padding:16px; max-width:1400px; margin:0 auto;
      }
      .card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); }
      .editor-scroll{ overflow:auto; }
      .page{
        width:840px; margin:24px auto; background:#fff; border:1px solid var(--border);
        border-radius:12px; box-shadow:var(--shadow);
      }
      .editor{
        min-height:1000px; padding:24px; outline:none; line-height:1.6; color:var(--text);
        word-wrap:break-word; overflow-wrap:anywhere; white-space:normal;
      }
      .editor:focus{ box-shadow: inset 0 0 0 2px #e6f0ff; }
      .sidebar{ display:flex; flex-direction:column; min-height:70vh; }
      .side-head{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; }
      .side-body{ padding:12px; display:flex; flex-direction:column; gap:10px; }

      textarea,input,select{ font:inherit; }
      .text{ width:100%; min-height:90px; border:1px solid var(--border); border-radius:10px; padding:10px; resize:vertical; }
      .out{
        display: none;
        white-space:pre-wrap; border:1px dashed #cfd6e6; border-radius:10px; padding:10px; background:#fbfcff;
        word-wrap:break-word; overflow-wrap:break-word; max-width:100%; box-sizing:border-box;
      }
      .row{ display:flex; gap:8px; align-items:center; }
      .pill{ font-size:12px; color:#fff; background:var(--blue); padding:2px 8px; border-radius:999px; }
      .muted{ color:var(--muted); font-size:12px; display: none;}
      .list{ padding:10px; border-top:1px solid var(--border); max-height:200px; overflow:auto; }
      .list .item{ padding:8px 10px; border-radius:8px; cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
      .list .item:hover{ background:#f6f7fb; }

      /* —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
      .editor h1{ font-size:28px; line-height:1.25; margin:0 0 12px; }
      .editor h2{ font-size:22px; line-height:1.3;  margin:18px 0 8px; }
      .editor h3{ font-size:18px; line-height:1.35; margin:14px 0 6px; }
      .editor p { font-size:15px; margin:8px 0; }
      .editor ul, .editor ol { padding-left:24px; margin:8px 0; }
      .editor li { margin:4px 0; }
      .editor hr { border:0; border-top:1px solid #e6e8ef; margin:16px 0; }
      .editor a { color:#0a73ff; text-decoration:underline; }
      .editor table { border-collapse:collapse; width:100%; margin:10px 0; }
      .editor th, .editor td { border:1px solid #e6e8ef; padding:6px 8px; text-align:left; vertical-align:top; }

      /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É –ø–æ —ç–∫—Ä–∞–Ω—É */
.login-wrap {
  max-width: 360px;
  margin: 10vh auto;
  padding: 32px 28px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 6px 24px rgba(0,0,0,0.1);
  text-align: center;
  animation: fadeIn 0.4s ease-in-out;
}

.login-wrap h2 {
  margin-bottom: 20px;
  font-size: 22px;
  font-weight: 600;
  color: #111826;
}

/* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
.login-wrap .input {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #d4d8e3;
  border-radius: 10px;
  font-size: 14px;
  margin-bottom: 14px;
  transition: border 0.2s, box-shadow 0.2s;
}

.login-wrap .input:focus {
  border-color: #0a73ff;
  box-shadow: 0 0 0 2px rgba(10,115,255,0.2);
  outline: none;
}

/* –ö–Ω–æ–ø–∫–∞ */
.login-wrap .btn {
  width: 100%;
  padding: 12px;
  background: #0a73ff;
  color: #fff;
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s;
}

.login-wrap .btn:hover {
  background: #0659c7;
}

.login-wrap .btn:active {
  background: #044aad;
}

/* –û—à–∏–±–∫–∏ */
.login-wrap .error {
  margin-top: 10px;
  color: #e54848;
  font-size: 13px;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è */
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(-10px);}
  to {opacity: 1; transform: translateY(0);}
}
    </style>
  </head>
  <body>
    <!-- LOGIN -->
    <div id="login" class="login-wrap card">
      <h2 style="margin:0 0 10px">–í—Ö–æ–¥ –≤ Genffice</h2>
      <div class="field">
        <input id="username" class="input" placeholder="username" />
      </div>
      <div class="field">
        <input id="password" type="password" class="input" placeholder="password"/>
      </div>
      <div class="row">
        <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
        <div id="loginError" class="error"></div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" style="display:none">
      <div class="topbar">
        <div class="brand">Genffice</div>
        <div class="spacer"></div>
        <input id="docName" class="docname" placeholder="–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" />
        <div class="user"><span class="dot"></span><span id="who" class="muted"></span></div>
      </div>

      <!-- Ribbon -->
      <div class="ribbon">
        <div class="group">
          <select id="block" class="select" onchange="applyBlock(this.value)">
            <option value="P">–ê–±–∑–∞—Ü</option>
            <option value="H1">–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1</option>
            <option value="H2">–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2</option>
            <option value="H3">–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3</option>
            <option value="PRE">–ö–æ–¥</option>
          </select>
          <button class="btn tog" id="bBold" onclick="cmd('bold',this)">B</button>
          <button class="btn tog" id="bIt"   onclick="cmd('italic',this)"><i>I</i></button>
          <button class="btn tog" id="bUn"   onclick="cmd('underline',this)"><u>U</u></button>
        </div>

        <div class="group">
          <button class="btn" onclick="cmd('insertUnorderedList')">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
          <button class="btn" onclick="cmd('insertOrderedList')">1. –°–ø–∏—Å–æ–∫</button>
          <button class="btn" onclick="makeLink()">–°—Å—ã–ª–∫–∞</button>
        </div>

        <div class="group">
          <button class="btn" onclick="saveDoc()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="newDoc()">‚ûï –ù–æ–≤—ã–π</button>
          <button class="btn" onclick="deleteDoc()">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>

        <div class="group">
          <button class="btn" onclick="exportPDF()">‚¨áÔ∏è PDF</button>
          <button class="btn" onclick="exportDOCX()">‚¨áÔ∏è DOCX</button>
        </div>

        <div class="spacer"></div>
        <div class="group" style="border-right:none">
          <span class="muted">–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
        </div>
      </div>

      <!-- Main layout -->
      <div class="wrap">
        <!-- Editor -->
        <div class="card editor-scroll">
          <div class="page">
            <div id="editor" class="editor" contenteditable="true"></div>
          </div>
        </div>

        <!-- AI side -->
        <div class="card sidebar">
          <div class="side-head">
            <strong>GEN AI</strong>
            <span class="pill">–í –±—É–¥—É—â–µ–µ –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏!</span>
            <span class="muted" style="margin-left:auto">/api/ai</span>
          </div>
          <div class="side-body">
            <textarea id="prompt" class="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–°–¥–µ–ª–∞–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –±–µ–∑ –∫–æ–º–ø–∞–Ω–∏–π –∏ –±—é–¥–∂–µ—Ç–æ–≤, —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏¬ª"></textarea>
            <div class="row">
              <button class="btn" onclick="runAI()">–û—Ç–≤–µ—Ç</button>
              <!-- <button class="btn" onclick="runAIStream()">–°—Ç—Ä–∏–º</button> -->
              <button class="btn" onclick="insertAIToDoc()">–í—Å—Ç–∞–≤–∏—Ç—å</button>
              <!-- <button class="btn" onclick="runAIHtml()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ‚Üí –≤—Å—Ç–∞–≤–∏—Ç—å</button> -->
            </div>
            <div class="muted">–†–µ–∑—É–ª—å—Ç–∞—Ç (Markdown):</div>
            <div id="aiOutput" class="out"></div>
            <div class="muted">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (Markdown ‚Üí HTML):</div>
            <div id="aiPreview" class="out"></div>
            <div class="muted">–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</div>
            <div id="aiReason" class="out"></div>
            <div class="row"><button class="btn" onclick="clearAI()">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
            <div class="muted">–ú–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</div>
            <div id="docsList" class="list"></div>
          </div>
        </div>
      </div>

      <!-- <div class="footer">Backend: http://127.0.0.1:8000/api</div> -->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PDF (html2pdf.js = html2canvas + jsPDF –≤ –æ–¥–Ω–æ–º –±–∞–Ω–¥–ª–µ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIPM4u8c7FkuQv2rCqgN0o0o8qG5LhJ6Hq6oGJ3neRr8mQ9u1H9J5v0J6etZlZyI1b1q3E7C2bJ3T1iG7QxA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-5hS5n8f3XzJq8N9aA9Y4y+eK6J8Y3bO3fCw5rX2S7xwS3n7xjYd8m1vNfO4WZ4R8qz+vQ7oZqUQd7C5iYd1Z4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.3.1/html-docx.js" integrity="sha512-1m8G3NYy0Q6v8l0T1h7u7y4mJ+uQ3W6dVQh6r7c4f4p8pQ3o0q2q5uH3pQfQ2tH5Q3V6yq0r5d3lqv0r0Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
      const BASE = `${window.location.origin}/api`;
      let token = null;
      let currentDoc = null;

      // ====== –£—Ç–∏–ª–∏—Ç—ã ======
      const $ = (id)=>document.getElementById(id);

      function pickContent(data){
        const obj = Array.isArray(data) ? data[0] : data;
        return obj?.choices?.[0]?.message?.content || obj?.text || "";
      }

      function insertHTMLAtCursor(html){
        const ed = $("editor");
        ed.focus();
        const sel = window.getSelection();
        if(sel && sel.rangeCount){
          let range = sel.getRangeAt(0);
          range.deleteContents();
          const el = document.createElement("div");
          el.innerHTML = html;
          const frag = document.createDocumentFragment();
          let node,last;
          while((node = el.firstChild)){ last = frag.appendChild(node); }
          range.insertNode(frag);
          if(last){
            range = range.cloneRange();
            range.setStartAfter(last);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
          }
        }else{
          ed.innerHTML += html;
        }
      }

      // ===== Markdown ‚Üí HTML (–±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫) =====
      
      function mdToHtml(md){
        md = escapeHtml(md || "").replace(/\r\n?/g, '\n');
        // ```code``` –±–ª–æ–∫–∏
        let codeBlocks = [];
        md = md.replace(/```([\s\S]*?)```/g, (_,code)=>{
          const idx = codeBlocks.push(`<pre><code>${code}</code></pre>`) - 1;
          return `\u0000CODE${idx}\u0000`;
        });

        const lines = md.split('\n');
        let html = '';
        let inUl=false, inOl=false, inTable=false;
        let tableHeader=null;

        const closeLists = ()=>{ if(inUl){html+='</ul>';inUl=false;} if(inOl){html+='</ol>';inOl=false;} };
        const closeTable = ()=>{ if(inTable){html+='</tbody></table>';inTable=false;tableHeader=null;} };

        for(let i=0;i<lines.length;i++){
          let line = lines[i];

          // --- hr ---
          if(/^\s*---+\s*$/.test(line)){ closeLists(); closeTable(); html+='<hr/>'; continue; }

          // --- table ---
          if(line.trim().startsWith('|') && line.trim().endsWith('|')){
            const next = lines[i+1] || '';
            if(!inTable){
              html += '<table><thead>';
              tableHeader = line;
              if(/^\s*\|?\s*:?-{3,}\s*(\|\s*:?-{3,}\s*)+\|?\s*$/.test(next)){
                const ths = tableHeader.slice(1,-1).split('|').map(s=>s.trim());
                html += '<tr>'+ths.map(h=>`<th>${mdInline(h)}</th>`).join('')+'</tr></thead><tbody>';
                inTable=true; i++; continue;
              }
            }
            if(inTable){
              const tds = line.slice(1,-1).split('|').map(s=>s.trim());
              html += '<tr>'+tds.map(td=>`<td>${mdInline(td).replace(/\n/g,'<br>')}</td>`).join('')+'</tr>';
              continue;
            }
          } else { closeTable(); }

          // --- headings ---
          const m = line.match(/^(#{1,6})\s+(.*)$/);
          if(m){
            closeLists();
            const lvl = m[1].length, text = mdInline(m[2]);
            html += `<h${lvl}>${text}</h${lvl}>`;
            continue;
          }

          // --- ordered list ---
          if(/^\s*\d+[\.\)]\s+/.test(line)){
            if(!inOl){ closeLists(); html+='<ol>'; inOl=true; }
            html += `<li>${mdInline(line.replace(/^\s*\d+[\.\)]\s+/,''))}</li>`;
            continue;
          } else if(inOl && line.trim()===''){ closeLists(); continue; }

          // --- unordered list ---
          if(/^\s*[-*]\s+/.test(line)){
            if(!inUl){ closeLists(); html+='<ul>'; inUl=true; }
            html += `<li>${mdInline(line.replace(/^\s*[-*]\s+/,''))}</li>`;
            continue;
          } else if(inUl && line.trim()===''){ closeLists(); continue; }

          // --- empty ---
          if(line.trim()===''){ closeLists(); html+=''; continue; }

          // --- paragraph ---
          closeLists();
          html += `<p>${mdInline(line)}</p>`;
        }

        closeLists(); closeTable();

        // –≤–µ—Ä–Ω—É—Ç—å code-–±–ª–æ–∫–∏
        html = html.replace(/\u0000CODE(\d+)\u0000/g, (_,i)=>codeBlocks[Number(i)]);
        return html;
      }

      // ====== –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ======
      async function login(){
        const u = $("username").value.trim();
        const p = $("password").value;
        try{
          const r = await fetch(BASE + "/auth/token/", {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ username:u, password:p })
          });
          if(!r.ok) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å");
          const d = await r.json();
          token = d.access;

          $("login").style.display = "none";
          $("app").style.display   = "block";
          $("who") && ($("who").textContent = u);

          await loadDocs();
          const has = document.querySelectorAll("#docsList .item").length > 0;
          if(!has) await newDoc();
        }catch(e){ $("loginError").textContent = e.message; }
      }

      function insertAIAsHTML() {
        const text = document.getElementById("aiOutput").textContent.trim();
        if (!text) return;

        // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º markdown ‚Üí html
        const html = marked.parse(text);

        // –≤—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä—è–º–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç
        insertHTMLAtCursor(html);
      }

      // ====== –î–æ–∫—É–º–µ–Ω—Ç—ã ======
      async function loadDocs(){
        const r = await fetch(BASE + "/documents/", { headers:{ Authorization:"Bearer "+token }});
        const docs = await r.json();
        const list = $("docsList"); if(!list) return;
        list.innerHTML = "";
        docs.forEach(doc=>{
          const div = document.createElement("div");
          div.className = "item";
          div.textContent = doc.title;
          div.onclick = ()=>openDoc(doc);
          list.appendChild(div);
        });
      }
      function openDoc(doc){
        currentDoc = doc;
        $("docName").value = doc.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        $("editor").innerHTML = doc.content_html || "";
      }
      async function newDoc(){
        const r = await fetch(BASE + "/documents/", {
          method:"POST",
          headers:{ Authorization:"Bearer "+token, "Content-Type":"application/json" },
          body: JSON.stringify({ title:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è", content_html:"" })
        });
        const doc = await r.json();
        openDoc(doc); loadDocs();
      }
      async function saveDoc(){
        if(!currentDoc) return;
        const title = $("docName").value || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        const html  = $("editor").innerHTML;
        const r = await fetch(`${BASE}/documents/${currentDoc.id}/`, {
          method:"PATCH",
          headers:{ Authorization:"Bearer "+token, "Content-Type":"application/json" },
          body: JSON.stringify({ title, content_html: html })
        });
        const doc = await r.json();
        openDoc(doc); loadDocs();
      }
      async function deleteDoc(){
        if(!currentDoc) return;
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?")) return;
        await fetch(`${BASE}/documents/${currentDoc.id}/`, {
          method:"DELETE", headers:{ Authorization:"Bearer "+token }
        });
        currentDoc=null; $("docName").value=""; $("editor").innerHTML=""; loadDocs();
      }

      // ====== –ö–æ–º–∞–Ω–¥—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ ======
      function cmd(name, btn){ document.execCommand(name,false,null); if(btn) btn.classList.toggle("active"); $("editor").focus(); }
      function applyBlock(tag){
        const val = tag==="P"?"<p>": tag==="PRE"?"<pre>": `<${tag.toLowerCase()}>`;
        document.execCommand("formatBlock", false, val); $("editor").focus();
      }
      function makeLink(){ const url=prompt("–í—Å—Ç–∞–≤—å—Ç–µ URL:","https://"); if(!url)return; document.execCommand("createLink", false, url); $("editor").focus(); }

      // ====== AI: –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å (Markdown) ======
      async function runAI() {
    const prompt = document.getElementById("prompt").value.trim();
    const content = document.getElementById("editor").innerHTML;
    const out = document.getElementById("aiOutput");
    const prev = document.getElementById("aiPreview");

    out.textContent = "‚Ä¶";
    if (prev) prev.innerHTML = "";

    const resp = await fetch(BASE + "/ai/", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ mode: "generate", prompt, html: content })
    });

    const data = await resp.json();
    const text = pickContent(data);

    // ‚úÖ –≤–æ—Ç –∑–¥–µ—Å—å –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º markdown ‚Üí html
    const html = marked.parse(text || "");

    // —Å—Ä–∞–∑—É –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç
    insertHTMLAtCursor(html);

    out.textContent = text || "‚ö†Ô∏è –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞"; // –∫–∞–∫ ¬´—Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç¬ª
    if (prev) prev.innerHTML = html;           // –∫–∞–∫ –∫—Ä–∞—Å–∏–≤–æ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω—ã–π HTML
    
  }

      // ====== AI: ¬´—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ‚Üí –≤—Å—Ç–∞–≤–∏—Ç—å¬ª (–æ–¥–∏–Ω–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å) ======
      async function runAIHtml(){
        const prompt = $("prompt").value.trim();
        const content = $("editor").innerHTML;
        const out = $("aiOutput");
        const prev = $("aiPreview");
        out.textContent = "‚Ä¶"; if(prev) prev.innerHTML = "";

        try{
          const resp = await fetch(BASE + "/ai/", {
            method:"POST",
            headers:{ Authorization:"Bearer "+token, "Content-Type":"application/json" },
            body: JSON.stringify({ mode:"generate", prompt, html: content })
          });
          if(!resp.ok){ out.textContent = "–û—à–∏–±–∫–∞: " + resp.status + " " + (await resp.text()); return; }
          const data = await resp.json();
          const md = pickContent(data);
          out.textContent = md || "‚ö†Ô∏è –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞";
          const html = mdToHtml(md || "");
          if(prev) prev.innerHTML = html;
          if(html) insertHTMLAtCursor(html);
        }catch(err){
          out.textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞: " + err.message;
        }
      }

      // ====== AI: —Å—Ç—Ä–∏–º (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å) ======
      async function runAIStream(){
        const prompt = $("prompt").value.trim();
        const content = $("editor").innerHTML;
        const out = $("aiOutput");
        const think = $("aiReason");
        const prev = $("aiPreview");

        out.textContent = ""; if(think) think.textContent = ""; if(prev) prev.innerHTML = "";

        const resp = await fetch(BASE + "/ai/stream/", {
          method:"POST",
          headers:{ Authorization:"Bearer "+token, "Content-Type":"application/json" },
          body: JSON.stringify({ mode:"generate", prompt, html: content })
        });
        if(!resp.ok){ out.textContent = "–û—à–∏–±–∫–∞: " + resp.status + " " + (await resp.text()); return; }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while(true){
          const { value, done } = await reader.read();
          if(done) break;
          buffer += decoder.decode(value, { stream:true });

          let idx;
          while((idx = buffer.indexOf("\n")) >= 0){
            const raw = buffer.slice(0, idx); buffer = buffer.slice(idx+1);
            const line = raw.trim(); if(!line || !line.startsWith("data:")) continue;
            const data = line.slice(5).trim();
            if(data === "[DONE]") return;

            try{
              const j = JSON.parse(data);
              const ch = j?.choices?.[0] || {};
              const d  = ch.delta || {};
              if(typeof d.reasoning_content === "string" && d.reasoning_content && think) think.textContent += d.reasoning_content;
              if(typeof d.content === "string" && d.content){
                out.textContent += d.content;
                if(prev) prev.innerHTML = mdToHtml(out.textContent);
              }
              const msg = ch?.message?.content;
              if(typeof msg === "string" && msg){
                out.textContent += msg;
                if(prev) prev.innerHTML = mdToHtml(out.textContent);
              }
            }catch{
              out.textContent += data;
              if(prev) prev.innerHTML = mdToHtml(out.textContent);
            }
          }
        }
      }

      // ====== –í—Å—Ç–∞–≤–∫–∏ –∏–∑ AI ======
      function insertAIToDoc(){
        const md = $("aiOutput").textContent.trim();
        if(!md) return;
        insertHTMLAtCursor( mdToHtml(md) );
      }
      function clearAI(){
        $("aiOutput").textContent = "";
        $("aiPreview").innerHTML = "";
        $("aiReason").textContent = "";
      }

      // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø–æ–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
  function getDocName(ext) {
    const name = (document.getElementById('docName')?.value || 'document')
      .trim()
      .replace(/[\\/:*?"<>|]+/g, '_')
    return name || ('document.' + ext);
  }

  // ===== –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF (html2pdf.js) =====
  async function exportPDF() {
    const page = document.querySelector('.page'); // –ø–µ—á–∞—Ç–∞–µ–º —Ä–æ–≤–Ω–æ ¬´–ª–∏—Å—Ç¬ª
    if (!page) return;

    const filename = getDocName('pdf');

    const opt = {
      margin:       [10, 10, 10, 10],      // –º–º
      filename,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    // –ß—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü—ã –∏ –¥–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –Ω–µ –ª–æ–º–∞–ª–∏ –≤—ë—Ä—Å—Ç–∫—É
    page.style.wordBreak = 'break-word';
    page.style.overflowWrap = 'anywhere';

    await html2pdf().set(opt).from(page).save();
  }

  // ===== –≠–∫—Å–ø–æ—Ä—Ç –≤ DOCX (html-docx-js) =====
  function exportDOCX() {
    const page = document.querySelector('.page');
    if (!page) return;

    const filename = getDocName('docx');

    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–µ–¥–µ—Ç –≤ Word
    const docxCss = `
      body { font-family: Arial, sans-serif; font-size: 12pt; color: #111; }
      h1 { font-size: 24pt; margin: 0 0 10pt; }
      h2 { font-size: 18pt; margin: 12pt 0 6pt; }
      h3 { font-size: 14pt; margin: 10pt 0 6pt; }
      p  { margin: 6pt 0; }
      ul, ol { margin: 6pt 0 6pt 18pt; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 6pt; vertical-align: top; }
      code, pre { font-family: Consolas, 'Courier New', monospace; }
    `;

    const html =
      '<!DOCTYPE html><html><head><meta charset="utf-8"><style>' +
      docxCss +
      '</style></head><body>' +
      page.innerHTML +
      '</body></html>';

    // –ø–æ–ª—è: 720 twips = 0.5" = ~12.7 –º–º
    const blob = window.htmlDocx.asBlob(html, {
      orientation: 'portrait',
      margins: { top: 720, right: 720, bottom: 720, left: 720 }
    });
    saveAs(blob, filename);
  }
    </script>
  </body>
</html>